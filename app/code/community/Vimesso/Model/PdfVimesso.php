<?phpclass Vimesso_Model_PdfVimesso extends Vimesso_Model_PdfHelper{        public function getPdf($order = null) {        // init         $this->_beforeGetPdf();        $this->_initRenderer('invoice');        $charset = 'UTF-8';        $LineHeight = 11;        $GrayScale = 0.2; // color        $margin = 28;        $_letterTotalHeight = 420;        $_letterTotalWidth = 595;        $fontSizeNormalText = 10;        if ($this->pdf == null) {            $this->pdf = new Zend_Pdf();        } else {            $this->firstPageIndex = count($this->pdf->pages);        }        // get vimesso        $vimesso = Mage::helper('vimesso')->getVimesso($order);                //add new page         $page = $this->NewPage(); // format LETTER US !!! landscape!!! '432:288:'        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA), $fontSizeNormalText); // set font size        //************************************************************************************************************************************        //header with logo        //************************************************************************************************************************************        // to add logo put the image into /media/vimesso        $logoPath = Mage::getBaseDir('media') . DS . 'vimesso' . DS . 'logo.jpg';        $logoWidth = 100;        $logoHeight = 80;        if (file_exists($logoPath)) {            $imageLogo = Zend_Pdf_Image::imageWithPath($logoPath);            $x1= ($_letterTotalWidth / 2) - ($logoWidth / 2);            $y1= $_letterTotalHeight - 30;            $x2= $x1 + $logoWidth;            $y2= $y1 - $logoHeight;            $page->drawImage($imageLogo,$x1, $y2, $x2, $y1); // x1, y2, x2, y1        }        //************************************************************************************************************************************        //text left column         //************************************************************************************************************************************        // text header        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA), $fontSizeNormalText); // set font size        $txtHeader = mage::helper('vimesso')->__("How exiting! The person who send the gift you just received made it even more unique by creating a \"vimesso\", a video message for your\ngift. To view it, simply follow the instructions below according to whether you will access from a comptuer or a mobile phone.\nHappy viewing!");        $txtHeader = $this->WrapTextToWidth($page, $txtHeader, $_letterTotalWidth / 2 - 10);        $totalLineHeight = $this->DrawMultilineText($page, $txtHeader, $margin, 270, $fontSizeNormalText, $GrayScale, $LineHeight); // $offset = $this->DrawMultilineText($page, $caption, 110, $this->y, 10, 0.2, 11);        $this->y -= $totalLineHeight + $LineHeight;        // information about sender and recipient          $txtInfo = mage::helper('vimesso')->__(sprintf("From : " . $vimesso->getSender() . "\nTo : " . $vimesso->getReceiver() . "\nSent :%s", date("F :j S: o")));        $totalLineHeight = $this->DrawMultilineText($page, $txtInfo, $margin, 170, $fontSizeNormalText, $GrayScale, $LineHeight); // $offset = $this->DrawMultilineText($page, $caption, 110, $this->y, 10, 0.2, 11);        $this->y -= $totalLineHeight + $LineHeight;        // message of vimesso        $messageOriginal = $vimesso->getCustomMessage();        $messageOriginal = html_entity_decode($messageOriginal);        $this->y -= 60; //$page->drawText(".    <----", $margin , 258, $charset);         $message = $this->WrapTextToWidth($page, $messageOriginal, $_letterTotalWidth / 2 - 10); // cute the string if more longer thna max allowed width        $totalLineHeight = $this->DrawMultilineText($page, $message, $margin,130, $fontSizeNormalText, $GrayScale, $LineHeight);         $this->y -= $totalLineHeight + $LineHeight;                //*****************************************************************************************************************        // text right column        //$page->drawText(".P2", 408 , 325, $charset);         //************************************************************************************************************************************                $this->y = 270;        $this->x = $_letterTotalWidth / 2 + 30;        // text computer        $tinyurl = new Zend_Service_ShortUrl_TinyUrlCom();         $creationUrl = $tinyurl->shorten($vimesso->getCreationLinkForVimesso());                // text header        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA_BOLD), $fontSizeNormalText); // bold        $textHeaderComputer = mage::helper('vimesso')->__("View your video message on the web");        $page->drawText($textHeaderComputer, $this->x , $this->y, $charset);         $this->y -= $LineHeight;        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA), $fontSizeNormalText); // set font size                $txtComputer = mage::helper('vimesso')->__("Your message is available at the following\naddress: " . $creationUrl . "");        $totalLineHeight = $this->DrawMultilineText($page, $txtComputer, $this->x, $this->y, $fontSizeNormalText, $GrayScale, $LineHeight); // $offset = $this->DrawMultilineText($page, $caption, 110, $this->y, 10, 0.2, 11);        $this->y -= $totalLineHeight + $LineHeight;                // text phone        $this->y -= 20;        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA_BOLD), $fontSizeNormalText); // bold        $txtHeaderPhone = mage::helper('vimesso')->__("View your vimesso message from a mobile");        $page->drawText($txtHeaderPhone, $this->x , $this->y, $charset);         $this->y -= $LineHeight;        $page->setFont(Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA), $fontSizeNormalText); // set font size                                $txtPhone = mage::helper('vimesso')->__("You may access your message by simply\nscannig* this QR code (or following the\nsame process as from a computer)");        $totalLineHeight = $this->DrawMultilineText($page, $txtPhone, $this->x, $this->y, $fontSizeNormalText, $GrayScale, $LineHeight); // $offset = $this->DrawMultilineText($page, $caption, 110, $this->y, 10, 0.2, 11);        $this->y -= $totalLineHeight + 8; //+ $LineHeight;                // draw QR Code        // get zend image from remote URl and put them into media/vimesso folder        $qRCodeImage = $this->getQrCodeImage($vimesso->getCode(), $vimesso->getCqr());        // get path of qr image        $QrCodeImagePath = Mage::getBaseDir('media') . DS . 'vimesso' . DS . $vimesso->getCode() . '.png';        $QrCodeImageSize = list($width, $height, $type, $attr) = getimagesize($QrCodeImagePath);                // draw QR image          $qrCodeSize = 100;                $this->x += 40;        $page->drawImage($qRCodeImage, $this->x, $this->y - $qrCodeSize, $this->x + $qrCodeSize, $this->y); // todo : automatic size         //$page->drawText(".P1",$this->x ,$this->y, $charset); //  x1, y2, x2, y1        //$page->drawText(".P2", $this->x + 88 , $this->y - 88 , $charset); // 484 : 75        $this->x -= 40;                // text QR code        //$page->drawText(".P4", 500 , 125, $charset);         $txtQrCode = mage::helper('vimesso')->__("* To scan this code you will need a scan reader, that\ncan be downloaded for free (for exmeple QR pal for\nIphone, Android or Blackberry)");        $totalLineHeight = $this->DrawMultilineText($page, $txtQrCode, $this->x, $this->y - $qrCodeSize, $fontSizeNormalText - 2, $GrayScale, $LineHeight); // $offset = $this->DrawMultilineText($page, $caption, 110, $this->y, 10, 0.2, 11);                //************************************************************************************************************************************        // footer with vimesso banner        //************************************************************************************************************************************                $vimessoBannerPath = Mage::getBaseDir('media') . DS . 'vimesso' . DS . 'vimesso_banner.jpg';        if (file_exists($vimessoBannerPath)) {            $imageLetter = Zend_Pdf_Image::imageWithPath($vimessoBannerPath);            $page->drawImage($imageLetter , 10, 0, $_letterTotalWidth - 10, 20); // x1, y2, x2, y1        }                $this->_afterGetPdf();                return $this->pdf;                      }    /*     * get image from distant web site and generate them with zend     */    public function getQrCodeImage($vimessoId, $url) {        // get QR code image form vimesso web site        $content = file_get_contents($url); // image 200 * 200 type PNG        $baseDir = Mage::getBaseDir() . DS . 'media' . DS . 'vimesso';        // create directory vimesso        if (!is_dir($baseDir))            mkdir($baseDir);        $filePath = $baseDir . DS . $vimessoId . '.png';        // create QR code image with url content        $handle = fopen($filePath, 'a');        fwrite($handle, $content);        fclose($handle);        // return zend image             return Zend_Pdf_Image::imageWithPath($filePath);    }}